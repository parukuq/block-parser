<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Block Data Parser</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/2933/2933116.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            justify-content: flex-start;
        }

        .logo {
            font-size: 2.5em;
            color: #4CAF50;
        }

        .header h2 {
            margin: 0;
        }

        .creator-text {
            margin-left: auto;
            color: #333;
            font-weight: bold;
            font-size: 1.2em;
            letter-spacing: 0.5px;
            text-shadow: 0.5px 0.5px 1px rgba(0,0,0,0.1);
        }

        #rowCount {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
            padding: 10px;
            background-color: #f4f4f4;
            border-radius: 4px;
            display: inline-block;
            border-left: 4px solid #4CAF50;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
            font-size: 14px;
        }

        th, td { 
            border: 1px solid #ddd; 
            padding: 12px 8px; 
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
            position: sticky;
            top: 0;
        }

        .matched { 
            background-color: #90EE90; 
        }

        .not-matched {
            background-color: #ffcccb;
        }

        textarea { 
            width: 100%; 
            height: 200px; 
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        #debug { 
            margin: 10px 0; 
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .button-container {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        select, input {
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .error {
            border-left: 4px solid #ff4444;
        }

        .success {
            border-left: 4px solid #4CAF50;
        }

        .highlight {
            animation: highlightRow 1s ease-in-out;
        }

        @keyframes highlightRow {
            0% { background-color: #ffffff; }
            50% { background-color: #e0ffe0; }
            100% { background-color: #ffffff; }
        }

        #copyNotification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            display: none;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            15% { opacity: 1; }
            85% { opacity: 1; }
            100% { opacity: 0; }
        }

        #loginSelect {
            width: 200px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-database logo"></i>
        <h2>Enhanced Block Data Parser</h2>
        <div class="creator-text"><strong>Created by: parukuq@amazon.com</strong></div>
    </div>
    
    <select id="loginSelect" onchange="updateLoginForAllRows()">
        <option value="">Select Login</option>
        <option value="parukuq">parukuq</option>
        <option value="pritiamz">pritiamz</option>
    </select>

    <div id="rowCount">Total Blocks: 0</div>

    <textarea id="rawData" placeholder="Paste your data here..."></textarea>
    <div class="button-container">
        <button onclick="parseData()">Parse Data</button>
        <button onclick="clearData()">Clear Table</button>
        <button onclick="copyAllRows()">Copy All Rows</button>
        <button onclick="exportToCSV()">Export to Excel</button>
        <button onclick="resetWorkbook()">Reset Workbook</button>
    </div>
    <div id="debug"></div>
    <div id="copyNotification">Row copied to clipboard!</div>
    <div style="overflow-x: auto;">
        <table id="resultTable">
            <thead>
                <tr>
                    <th>Login</th>
                    <th>Blocks</th>
                    <th>Domiciles</th>
                    <th>Block Cost</th>
                    <th>Status</th>
                    <th>RLB Cost</th>
                    <th>Opportunity</th>
                    <th>Hours</th>
                    <th>Minutes</th>
                    <th>Block start time</th>
                    <th>Block end time</th>
                    <th>Comments</th>
                    <th>MMRO Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        let workbook = null;

        function updateRowCount() {
            const table = document.getElementById('resultTable');
            const blockCount = table.rows.length - 1; // Subtract 1 to exclude header row
            document.getElementById('rowCount').innerHTML = `Total Blocks: ${blockCount}`;
            return blockCount;
        }

        function updateLoginForAllRows() {
            const loginValue = document.getElementById('loginSelect').value;
            const table = document.getElementById('resultTable');
            const rows = table.getElementsByTagName('tr');
            
            for(let i = 1; i < rows.length; i++) {
                const loginCell = rows[i].cells[0];
                loginCell.textContent = loginValue;
            }
        }

        function parseData() {
            const rawData = document.getElementById('rawData').value;
            const loginValue = document.getElementById('loginSelect').value;
            
            if (!loginValue) {
                showMessage('Please select a login first!', true);
                return;
            }

            document.getElementById('debug').innerHTML = 'Processing...';

            try {
                const temp = document.createElement('div');
                temp.innerHTML = rawData;

                let blockId = '';
                let domicile = '';
                let startTime = '';
                let endTime = '';
                let hours = '';
                let minutes = '';
                let cost = '';

                const spans = temp.getElementsByTagName('span');
                for(let span of spans) {
                    const text = span.textContent.trim();
                    console.log('Checking text:', text);

                    if(text.match(/^B-[A-Z0-9]+$/)) {
                        blockId = text;
                    }
                    else if(text.match(/^[A-Z]{3}[0-9]$/) && !domicile) {
                        domicile = text;
                    }
                    else if(text.includes('PDT -') || text.includes('EDT -') || 
                            text.includes('CDT -') || text.includes('MDT -') ||
                            text.includes('PST -') || text.includes('EST -') || 
                            text.includes('CST -') || text.includes('MST -')) {
                        const times = text.split('-');
                        if(times.length === 2) {
                            startTime = times[0].trim();
                            endTime = times[1].replace(/<br>|\n/g, '').trim();
                        }
                    }
                    else if(text.match(/^\d+h(\d+m)?$/)) {
                        if(text.includes('m')) {
                            const durationMatch = text.match(/(\d+)h(\d+)m/);
                            if(durationMatch) {
                                hours = durationMatch[1];
                                minutes = durationMatch[2];
                            }
                        } else {
                            const durationMatch = text.match(/(\d+)h/);
                            if(durationMatch) {
                                hours = durationMatch[1];
                                minutes = "00";
                            }
                        }
                    }
                }

                const paragraphs = temp.getElementsByTagName('p');
                for(let p of paragraphs) {
                    if(p.textContent.includes('Total Cost:')) {
                        const costMatch = p.textContent.match(/\$[\d,]+\.\d{2}/);
                        if(costMatch) {
                            cost = costMatch[0];
                            break;
                        }
                    }
                }

                addTableRow({
                    login: loginValue,
                    blockId,
                    domicile,
                    cost,
                    hours,
                    minutes,
                    startTime,
                    endTime
                });

                document.getElementById('rawData').value = '';
                updateRowCount();
                showMessage('Data processed successfully');

            } catch(error) {
                showMessage('Error: ' + error.message, true);
                console.error(error);
            }
        }

        function addTableRow(data) {
            const table = document.getElementById('resultTable');
            const row = table.insertRow(-1);
            
            row.insertCell(0).textContent = data.login || '';
            row.insertCell(1).textContent = data.blockId || '';
            row.insertCell(2).textContent = data.domicile || '';
            row.insertCell(3).textContent = data.cost || '';
            
            const matchedCell = row.insertCell(4);
            matchedCell.textContent = 'Matched';
            matchedCell.className = 'matched';

            row.insertCell(5).textContent = '';

            const opportunityCell = row.insertCell(6);
            const opportunityInput = document.createElement('input');
            opportunityInput.type = 'text';
            opportunityInput.placeholder = 'Paste opportunity here';
            opportunityInput.style.width = '100%';
            opportunityCell.appendChild(opportunityInput);

            row.insertCell(7).textContent = data.hours || '';
            row.insertCell(8).textContent = data.minutes || '';
            row.insertCell(9).textContent = data.startTime || '';
            row.insertCell(10).textContent = data.endTime || '';
            
            const commentCell = row.insertCell(11);
            const commentSelect = document.createElement('select');
            commentSelect.innerHTML = `
                <option value=""></option>
                <option>VRID added within 8 hrs to block start time</option>
                <option>VRID added with 12-34 hrs to block start time</option>
            `;
            commentCell.appendChild(commentSelect);

            const mmroCell = row.insertCell(12);
            const mmroSelect = document.createElement('select');
            mmroSelect.innerHTML = `
                <option value=""></option>
                <option>MMRO</option>
                <option>NON MMRO</option>
            `;
            mmroCell.appendChild(mmroSelect);

            const actionCell = row.insertCell(13);
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '🗑️';
            deleteBtn.onclick = function() { deleteRow(this); };
            deleteBtn.style.backgroundColor = '#ff4444';
            actionCell.appendChild(deleteBtn);

            updateRowCount();
        }

        function clearData() {
            if (document.getElementById('resultTable').rows.length > 1) {
                if (confirm("Are you sure you want to clear the table? This action cannot be undone.")) {
                    const table = document.getElementById('resultTable');
                    while(table.rows.length > 1) {
                        table.deleteRow(1);
                    }
                    document.getElementById('rawData').value = '';
                    document.getElementById('debug').innerHTML = '';
                    document.getElementById('loginSelect').value = '';
                    updateRowCount();
                }
            } else {
                showMessage('Table is already empty!');
            }
        }

        function deleteRow(btn) {
            if (confirm("Are you sure you want to delete this row?")) {
                const row = btn.parentNode.parentNode;
                row.parentNode.removeChild(row);
                updateRowCount();
            }
        }

        function exportToCSV() {
            const table = document.getElementById('resultTable');
            let data = [];
            
            let headers = [];
            for(let i = 0; i < table.rows[0].cells.length - 1; i++) {
                headers.push(table.rows[0].cells[i].innerText);
            }
            data.push(headers);
            
            for(let i = 1; i < table.rows.length; i++) {
                let row = [];
                for(let j = 0; j < table.rows[i].cells.length - 1; j++) {
                    let cell = table.rows[i].cells[j];
                    let value;
                    if (cell.querySelector('select')) {
                        value = cell.querySelector('select').value;
                    } else if (cell.querySelector('input')) {
                        value = cell.querySelector('input').value;
                    } else {
                        value = cell.innerText;
                    }
                    row.push(value);
                }
                data.push(row);
            }

            if (!workbook) {
                workbook = XLSX.utils.book_new();
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const now = new Date();
            const sheetName = `Sheet_${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;
            XLSX.utils.book_append_sheet(workbook, ws, sheetName);
            XLSX.writeFile(workbook, 'block_data.xlsx');
        }

        function resetWorkbook() {
            workbook = null;
            showMessage('Workbook reset successfully');
        }

        function copyAllRows() {
            const table = document.getElementById('resultTable');
            let allRowsText = [];
            
            for(let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const rowData = [];
                
                for(let j = 0; j < row.cells.length - 1; j++) {
                    const cell = row.cells[j];
                    if(cell.querySelector('select')) {
                        rowData.push(cell.querySelector('select').value);
                    } else if(cell.querySelector('input')) {
                        rowData.push(cell.querySelector('input').value);
                    } else {
                        rowData.push(cell.textContent.trim());
                    }
                }
                
                allRowsText.push(rowData.join('\t'));
            }
            
            const textToCopy = allRowsText.join('\n');
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const notification = document.getElementById('copyNotification');
                notification.textContent = 'All rows copied to clipboard!';
                notification.style.display = 'block';
                
                for(let i = 1; i < table.rows.length; i++) {
                    table.rows[i].classList.add('highlight');
                }
                
                setTimeout(() => {
                    notification.style.display = 'none';
                    for(let i = 1; i < table.rows.length; i++) {
                        table.rows[i].classList.remove('highlight');
                    }
                }, 2000);
            }).catch(err => {
                showMessage('Error copying data: ' + err, true);
            });
        }

        function showMessage(message, isError = false) {
            const debug = document.getElementById('debug');
            debug.textContent = message;
            debug.className = isError ? 'error' : 'success';
            setTimeout(() => {
                debug.className = '';
                debug.textContent = '';
            }, 3000);
        }

        // Add page refresh/close confirmation
        window.addEventListener('beforeunload', function(e) {
            const table = document.getElementById('resultTable');
            if (table.rows.length > 1) {
                e.preventDefault();
                e.returnValue = '';
                return 'Are you sure you want to leave? Any unsaved data will be lost.';
            }
        });

        // Optional: Add warning for accidental back button press
        window.onpopstate = function(event) {
            if (document.getElementById('resultTable').rows.length > 1) {
                if (!confirm("Are you sure you want to leave? Any unsaved data will be lost.")) {
                    history.pushState(null, null, window.location.pathname);
                }
            }
        };

        // Push initial state
        history.pushState(null, null, window.location.pathname);

        // Initialize block count
        updateRowCount();
    </script>
</body>
</html>
