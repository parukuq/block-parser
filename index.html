<!DOCTYPE html>
<html>
<head>
    <title>Enhanced Block Data Parser</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/2933/2933116.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 2.5em;
            color: #4CAF50;
        }

        .header h2 {
            margin: 0;
            color: #333;
        }

        .creator-text {
            margin-left: auto;
            color: #333;
            font-weight: bold;
            font-size: 1.2em;
            letter-spacing: 0.5px;
        }

        .main-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .top-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .opportunity-section {
            width: 400px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .login-section {
            flex-grow: 1;
        }

        h3 {
            margin: 0;
            color: #4CAF50;
            padding: 10px 0;
            font-size: 1.1em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        #loginSelect, #commentPreset, #mmroPreset {
            width: 100%;
            height: 38px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            background-color: white;
        }

        #opportunityData {
            height: 100px;
            margin-bottom: 10px;
        }

        #rawData {
            height: 200px;
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        button:hover {
            background-color: #45a049;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .matched {
            background-color: #d4edda;
        }

        .not-matched {
            background-color: #f8d7da;
        }

        .preset-controls {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }

        #rowCount {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            display: inline-block;
            border-left: 4px solid #4CAF50;
        }

        #debug {
            margin: 10px 0;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .highlight {
            animation: highlightRow 1s ease-in-out;
        }

        @keyframes highlightRow {
            0% { background-color: #ffffff; }
            50% { background-color: #e0ffe0; }
            100% { background-color: #ffffff; }
        }

        #copyNotification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            display: none;
            animation: fadeInOut 2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
    </style>
</head>
<body>
    <div class="header">
        <i class="fas fa-database logo"></i>
        <h2>Enhanced Block Data Parser</h2>
        <div class="creator-text">Created by: parukuq@amazon.com</div>
    </div>

    <div class="main-container">
        <div class="top-section">
            <div class="opportunity-section">
                <h3>Input Controls</h3>
                <div class="preset-controls">
                    <div class="input-group">
                        <select id="commentPreset">
                            <option value="">Select Comment Preset</option>
                            <option>VRID added within 8 hrs to block start time</option>
                            <option>VRID added with 12-34 hrs to block start time</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <select id="mmroPreset">
                            <option value="">Select MMRO Status</option>
                            <option>MMRO</option>
                            <option>NON MMRO</option>
                        </select>
                    </div>
                </div>
                <textarea 
                    id="opportunityData" 
                    placeholder="Paste opportunity data here..."
                    onpaste="setTimeout(fillOpportunity, 0)"
                    onchange="fillOpportunity()"
                ></textarea>
            </div>
            <div class="login-section">
                <select id="loginSelect" onchange="updateLoginForAllRows()">
                    <option value="">Select Login</option>
                    <option value="parukuq">parukuq</option>
                    <option value="errabel">errabel</option>
                </select>
                <textarea 
                    id="rawData" 
                    placeholder="Paste your block data here..."
                ></textarea>
            </div>
        </div>

        <div id="rowCount">Total Blocks: 0</div>
        
        <div class="button-container">
            <button onclick="parseData()">Parse Data</button>
            <button onclick="clearData()">Clear Table</button>
            <button onclick="copyAllRows()">Copy All Rows</button>
            <button onclick="exportToCSV()">Export to Excel</button>
            <button onclick="resetWorkbook()">Reset Workbook</button>
        </div>

        <div id="debug"></div>
        <div id="copyNotification">Row copied to clipboard!</div>

        <div style="overflow-x: auto;">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>Login</th>
                        <th>Blocks</th>
                        <th>Domiciles</th>
                        <th>Block Cost</th>
                        <th>Status</th>
                        <th>RLB Cost</th>
                        <th>Opportunity</th>
                        <th>Hours</th>
                        <th>Minutes</th>
                        <th>Block start time</th>
                        <th>Block end time</th>
                        <th>Comments</th>
                        <th>MMRO Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        let workbook = null;

        function updateRowCount() {
            const table = document.getElementById('resultTable');
            const blockCount = table.rows.length - 1;
            document.getElementById('rowCount').innerHTML = `Total Blocks: ${blockCount}`;
            return blockCount;
        }

        function fillOpportunity() {
            const opportunityData = document.getElementById('opportunityData').value.trim();
            const commentPreset = document.getElementById('commentPreset').value;
            const mmroPreset = document.getElementById('mmroPreset').value;
            
            if (!opportunityData) return;

            const table = document.getElementById('resultTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const opportunityCell = rows[i].cells[6];
                const opportunityInput = opportunityCell.querySelector('input');
                
                if (!opportunityInput.value) {
                    opportunityInput.value = opportunityData;
                    
                    if (commentPreset) {
                        const commentSelect = rows[i].cells[11].querySelector('select');
                        commentSelect.value = commentPreset;
                    }
                    
                    if (mmroPreset) {
                        const mmroSelect = rows[i].cells[12].querySelector('select');
                        mmroSelect.value = mmroPreset;
                    }
                    
                    document.getElementById('opportunityData').value = '';
                    rows[i].classList.add('highlight');
                    setTimeout(() => {
                        rows[i].classList.remove('highlight');
                    }, 2000);
                    return;
                }
            }
            showMessage('No empty opportunity cells found!', true);
        }

        function updateLoginForAllRows() {
            const loginValue = document.getElementById('loginSelect').value;
            const table = document.getElementById('resultTable');
            const rows = table.getElementsByTagName('tr');
            
            for(let i = 1; i < rows.length; i++) {
                const loginCell = rows[i].cells[0];
                loginCell.textContent = loginValue;
            }
        }

        function parseData() {
            const rawData = document.getElementById('rawData').value;
            const loginValue = document.getElementById('loginSelect').value;
            
            if (!loginValue) {
                showMessage('Please select a login first!', true);
                return;
            }

            document.getElementById('debug').innerHTML = 'Processing...';

            try {
                const temp = document.createElement('div');
                temp.innerHTML = rawData;

                let blockId = '';
                let domicile = '';
                let startTime = '';
                let endTime = '';
                let hours = '';
                let minutes = '';
                let cost = '';

                const spans = temp.getElementsByTagName('span');
                for(let span of spans) {
                    const text = span.textContent.trim();

                    if(text.match(/^B-[A-Z0-9]+$/)) {
                        blockId = text;
                    }
                    else if(text.match(/^[A-Z]{3}[0-9]$/) && !domicile) {
                        domicile = text;
                    }
                    else if(text.includes('PDT -') || text.includes('EDT -') || 
                            text.includes('CDT -') || text.includes('MDT -') ||
                            text.includes('PST -') || text.includes('EST -') || 
                            text.includes('CST -') || text.includes('MST -')) {
                        const times = text.split('-');
                        if(times.length === 2) {
                            startTime = times[0].trim();
                            endTime = times[1].replace(/<br>|\n/g, '').trim();
                        }
                    }
                    else if(text.match(/^\d+h(\d+m)?$/)) {
                        if(text.includes('m')) {
                            const durationMatch = text.match(/(\d+)h(\d+)m/);
                            if(durationMatch) {
                                hours = durationMatch[1];
                                minutes = durationMatch[2];
                            }
                        } else {
                            const durationMatch = text.match(/(\d+)h/);
                            if(durationMatch) {
                                hours = durationMatch[1];
                                minutes = "00";
                            }
                        }
                    }
                }

                const paragraphs = temp.getElementsByTagName('p');
                for(let p of paragraphs) {
                    if(p.textContent.includes('Total Cost:')) {
                        const costMatch = p.textContent.match(/\$[\d,]+\.\d{2}/);
                        if(costMatch) {
                            cost = costMatch[0];
                            break;
                        }
                    }
                }

                addTableRow({
                    login: loginValue,
                    blockId,
                    domicile,
                    cost,
                    hours,
                    minutes,
                    startTime,
                    endTime
                });

                document.getElementById('rawData').value = '';
                updateRowCount();
                showMessage('Data processed successfully');

            } catch(error) {
                showMessage('Error: ' + error.message, true);
                console.error(error);
            }
        }

        function addTableRow(data) {
            const table = document.getElementById('resultTable');
            const row = table.insertRow(-1);
            
            row.insertCell(0).textContent = data.login || '';
            row.insertCell(1).textContent = data.blockId || '';
            row.insertCell(2).textContent = data.domicile || '';
            row.insertCell(3).textContent = data.cost || '';
            
            const matchedCell = row.insertCell(4);
            matchedCell.textContent = 'Matched';
            matchedCell.className = 'matched';

            row.insertCell(5).textContent = '';

            const opportunityCell = row.insertCell(6);
            const opportunityInput = document.createElement('input');
            opportunityInput.type = 'text';
            opportunityInput.placeholder = 'Paste opportunity here';
            opportunityInput.style.width = '100%';
            opportunityCell.appendChild(opportunityInput);

            row.insertCell(7).textContent = data.hours || '';
            row.insertCell(8).textContent = data.minutes || '';
            row.insertCell(9).textContent = data.startTime || '';
            row.insertCell(10).textContent = data.endTime || '';
            
            const commentCell = row.insertCell(11);
            const commentSelect = document.createElement('select');
            commentSelect.innerHTML = `
                <option value=""></option>
                <option>VRID added within 8 hrs to block start time</option>
                <option>VRID added with 12-34 hrs to block start time</option>
            `;
            const currentCommentPreset = document.getElementById('commentPreset').value;
            if (currentCommentPreset) {
                commentSelect.value = currentCommentPreset;
            }
            commentCell.appendChild(commentSelect);

            const mmroCell = row.insertCell(12);
            const mmroSelect = document.createElement('select');
            mmroSelect.innerHTML = `
                <option value=""></option>
                <option>MMRO</option>
                <option>NON MMRO</option>
            `;
            const currentMmroPreset = document.getElementById('mmroPreset').value;
            if (currentMmroPreset) {
                mmroSelect.value = currentMmroPreset;
            }
            mmroCell.appendChild(mmroSelect);

            const actionCell = row.insertCell(13);
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '🗑️';
            deleteBtn.onclick = function() { deleteRow(this); };
            deleteBtn.style.backgroundColor = '#ff4444';
            actionCell.appendChild(deleteBtn);

            row.classList.add('highlight');
            setTimeout(() => {
                row.classList.remove('highlight');
            }, 2000);

            updateRowCount();
        }

        function clearData() {
            if (document.getElementById('resultTable').rows.length > 1) {
                if (confirm("Are you sure you want to clear the table? This action cannot be undone.")) {
                    const table = document.getElementById('resultTable');
                    while(table.rows.length > 1) {
                        table.deleteRow(1);
                    }
                    document.getElementById('rawData').value = '';
                    document.getElementById('opportunityData').value = '';
                    document.getElementById('debug').innerHTML = '';
                    document.getElementById('loginSelect').value = '';
                    document.getElementById('commentPreset').value = '';
                    document.getElementById('mmroPreset').value = '';
                    updateRowCount();
                }
            } else {
                showMessage('Table is already empty!');
            }
        }

        function deleteRow(btn) {
            if (confirm("Are you sure you want to delete this row?")) {
                const row = btn.parentNode.parentNode;
                row.parentNode.removeChild(row);
                updateRowCount();
            }
        }

        function exportToCSV() {
    // If workbook doesn't exist, create a new one
    if (!workbook) {
        workbook = XLSX.utils.book_new();
    }

    const table = document.getElementById('resultTable');
    let data = [];
    
    // Get headers
    let headers = [];
    for(let i = 0; i < table.rows[0].cells.length - 1; i++) {
        headers.push(table.rows[0].cells[i].innerText);
    }
    data.push(headers);
    
    // Get data from table
    for(let i = 1; i < table.rows.length; i++) {
        let row = [];
        for(let j = 0; j < table.rows[i].cells.length - 1; j++) {
            let cell = table.rows[i].cells[j];
            let value;
            if (cell.querySelector('select')) {
                value = cell.querySelector('select').value;
            } else if (cell.querySelector('input')) {
                value = cell.querySelector('input').value;
            } else {
                value = cell.innerText;
            }
            row.push(value);
        }
        data.push(row);
    }

    // Create a new worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Generate unique sheet name with timestamp
    const now = new Date();
    const sheetName = `Sheet_${now.getHours()}${now.getMinutes()}${now.getSeconds()}`;
    
    // Add the worksheet to the existing workbook
    XLSX.utils.book_append_sheet(workbook, ws, sheetName);
    
    // Write the workbook to file
    XLSX.writeFile(workbook, 'block_data.xlsx');
    
    showMessage(`Added new sheet: ${sheetName}`);
}


        function copyAllRows() {
            const table = document.getElementById('resultTable');
            let allRowsText = [];
            
            for(let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const rowData = [];
                
                for(let j = 0; j < row.cells.length - 1; j++) {
                    const cell = row.cells[j];
                    if(cell.querySelector('select')) {
                        rowData.push(cell.querySelector('select').value);
                    } else if(cell.querySelector('input')) {
                        rowData.push(cell.querySelector('input').value);
                    } else {
                        rowData.push(cell.textContent.trim());
                    }
                }
                
                allRowsText.push(rowData.join('\t'));
            }
            
            const textToCopy = allRowsText.join('\n');
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const notification = document.getElementById('copyNotification');
                notification.textContent = 'All rows copied to clipboard!';
                notification.style.display = 'block';
                
                for(let i = 1; i < table.rows.length; i++) {
                    table.rows[i].classList.add('highlight');
                }
                
                setTimeout(() => {
                    notification.style.display = 'none';
                    for(let i = 1; i < table.rows.length; i++) {
                        table.rows[i].classList.remove('highlight');
                    }
                }, 2000);
            }).catch(err => {
                showMessage('Error copying data: ' + err, true);
            });
        }

        function showMessage(message, isError = false) {
            const debug = document.getElementById('debug');
            debug.textContent = message;
            debug.className = isError ? 'error' : 'success';
            setTimeout(() => {
                debug.className = '';
                debug.textContent = '';
            }, 3000);
        }

        window.addEventListener('beforeunload', function(e) {
            const table = document.getElementById('resultTable');
            if (table.rows.length > 1) {
                e.preventDefault();
                e.returnValue = '';
                return 'Are you sure you want to leave? Any unsaved data will be lost.';
            }
        });

        window.onpopstate = function(event) {
            if (document.getElementById('resultTable').rows.length > 1) {
                if (!confirm("Are you sure you want to leave? Any unsaved data will be lost.")) {
                    history.pushState(null, null, window.location.pathname);
                }
            }
        };

        history.pushState(null, null, window.location.pathname);
        updateRowCount();
    </script>
</body>
</html>
